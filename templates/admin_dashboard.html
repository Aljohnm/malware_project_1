<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            padding: 50px;
        }

        h1 {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .main-content {
            background-color: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            cursor: pointer;
            border: none;
            background-color: #36a2eb;
            color: white;
            font-size: 18px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #1d8ad5;
        }

        /* Upload button styling */
        #uploadForm {
            margin: 20px auto;
            text-align: center;
        }

        #fileInput {
            display: none;
        }

        .upload-label {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-block;
        }

        .upload-label:hover {
            background-color: #218838;
        }

        #uploadBtn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #36a2eb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #uploadBtn:hover {
            background-color: #1d8ad5;
        }

        /* Progress bar styling */
        .progress-bar-container {
            width: 80%;
            margin: 20px auto;
            background-color: #f2f2f2;
            border-radius: 5px;
            height: 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 0;
            height: 100%;
            background-color: #28a745;
            border-radius: 5px;
            transition: width 0.4s ease;
        }

        #fileName {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
        }

        #statusMessage {
            margin-top: 10px;
            font-size: 18px;
            color: #28a745;
        }

        #statusMessage.error {
            color: #dc3545;
        }
		 .hidden {
        display: none;
    }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 main-content">
                <h1 class="text-center">Welcome to the Malware Detection System</h1>
                <p class="lead text-center">Use this system to detect and analyze malware on your PC.</p>

                <!-- Buttons for toggling between sections -->
                <div class="button-container">
                    <button class="btn" onclick="showSection('dataPrediction')">Show Data Prediction</button>
                    <button class="btn" onclick="showSection('dataVisualization')">Show Data Visualization</button>
                    <button class="btn" onclick="openChatbot()">Open Malware Detection Chatbot</button>
                </div>

                <!-- File Upload Form -->
                <form id="uploadForm" action="/upload/" method="post" enctype="multipart/form-data">
                    <label class="upload-label" for="fileInput">Choose File</label>
                    <input type="file" name="file" id="fileInput" required>
                    <button id="uploadBtn" type="submit">Upload</button>
                </form>

                <!-- Display selected file name -->
                <div id="fileName"></div>

                <!-- Progress Bar -->
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <!-- Status Message -->
                <div id="statusMessage"></div>
            </div>
        </div>
    </div>

    <!-- Data Prediction Section -->
    <div id="dataPrediction" class="hidden">
        <h2>Accuracy: <span id="accuracy"></span></h2>
        <h3>Incorrect Predictions:</h3>
        <div id="incorrectPreds"></div>
    </div>

    <!-- Data Visualization Section -->
    <div id="dataVisualization" class="hidden">
        <h3>Trained Dataset Summary</h3>
        <h4>Category Distribution</h4>
        <div class="chart-container">
            <canvas id="trainedCategoryChart"></canvas>
        </div>

        <h4>Memory Usage by Category</h4>
        <div class="chart-container">
            <canvas id="trainedMemoryChart"></canvas>
        </div>

        <h4>Battery Usage by Category</h4>
        <div class="chart-container">
            <canvas id="trainedBatteryChart"></canvas>
        </div>

        <h4>Network Usage by Category</h4>
        <div class="chart-container">
            <canvas id="trainedNetworkChart"></canvas>
        </div>

        <h3>Uploaded Dataset Results</h3>
        <h4>Trojan Category Distribution</h4>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>

        <h4>Memory Usage by Trojan Category</h4>
        <div class="chart-container">
            <canvas id="memoryChart"></canvas>
        </div>

        <h4>Battery Usage by Trojan Category</h4>
        <div class="chart-container">
            <canvas id="batteryChart"></canvas>
        </div>

        <h4>Network Usage by Trojan Category</h4>
        <div class="chart-container">
            <canvas id="networkChart"></canvas>
        </div>

        <!-- Comparison Section -->
        <h3>Comparison of Trained and Uploaded Dataset</h3>
        <h4>Category Distribution Comparison</h4>
        <div class="chart-container">
            <canvas id="categoryComparisonChart"></canvas>
        </div>

        <h4>Memory Usage Comparison</h4>
        <div class="chart-container">
            <canvas id="memoryComparisonChart"></canvas>
        </div>

        <h4>Battery Usage Comparison</h4>
        <div class="chart-container">
            <canvas id="batteryComparisonChart"></canvas>
        </div>

        <h4>Network Usage Comparison</h4>
        <div class="chart-container">
            <canvas id="networkComparisonChart"></canvas>
        </div>
    </div>

<script>
    let trainedSummary = {};

    // Load trained dataset summary on window load
    window.onload = function () {
        // Select elements after the DOM has fully loaded
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const uploadForm = document.getElementById('uploadForm');

        // Display the selected file name
        fileInput.addEventListener('change', function () {
            const file = fileInput.files[0];
            if (file) {
                fileNameDisplay.textContent = `Selected File: ${file.name}`;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        // Handle form submission for file upload
        uploadForm.onsubmit = async function (event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            try {
                const response = await fetch(this.action, {
                    method: this.method,
                    body: formData,
                });
                if (!response.ok) throw new Error("File upload failed");

                const result = await response.json();
                console.log("Uploaded file result:", result); // Debug: Log uploaded result

                // Update accuracy and incorrect predictions
                document.getElementById('accuracy').innerText = result.accuracy;
                const incorrectPredsDiv = document.getElementById('incorrectPreds');
                incorrectPredsDiv.innerHTML = ''; // Clear previous results
                if (result.incorrect_predictions.length > 0) {
                    const table = document.createElement('table');
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = '<th>Index</th><th>True Label</th><th>Predicted Label</th>';
                    table.appendChild(headerRow);

                    result.incorrect_predictions.forEach(pred => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${pred.index}</td><td>${pred.true_label}</td><td>${pred.predicted_label}</td>`;
                        table.appendChild(row);
                    });
                    incorrectPredsDiv.appendChild(table);
                } else {
                    incorrectPredsDiv.innerText = 'No incorrect predictions.';
                }

                // Render uploaded dataset charts and comparison charts
                renderUploadedDatasetCharts(result);
                renderComparisonCharts(result);

                // Show success message
                statusMessage.textContent = 'File successfully uploaded!';
                statusMessage.classList.remove('error');
            } catch (error) {
                console.error("Error during file upload or chart rendering:", error);
                statusMessage.textContent = 'Failed to upload the file.';
                statusMessage.classList.add('error');
            }
        };

        // Load the trained dataset summary when the page loads
        loadTrainedDatasetSummary();
    };

    // Load trained dataset summary
    async function loadTrainedDatasetSummary() {
        try {
            const response = await fetch('/trained_dataset_summary/');
            if (!response.ok) {
                throw new Error("Failed to load trained dataset summary");
            }
            trainedSummary = await response.json();
            console.log("Trained summary:", trainedSummary); // Debug: Log the response

            // Proceed to render charts after the data is loaded
            renderTrainedDatasetCharts();
        } catch (error) {
            console.error("Error loading trained dataset summary:", error);
        }
    }

    // Function to render trained dataset charts (Trained charts)
    function renderTrainedDatasetCharts() {
        // Check if the data is valid before rendering
        if (!trainedSummary || !Object.keys(trainedSummary).length) {
            console.error("Trained summary is empty or invalid.");
            return;
        }

        const trainedCategoryLabels = Object.keys(trainedSummary.category_distribution);
        const trainedCategoryData = Object.values(trainedSummary.category_distribution);
        const trainedMemoryData = Object.values(trainedSummary.memory_usage);
        const trainedBatteryData = Object.values(trainedSummary.battery_usage);
        const trainedNetworkData = Object.values(trainedSummary.network_usage);

        // Create trained category distribution chart
        new Chart(document.getElementById('trainedCategoryChart'), {
            type: 'pie',
            data: {
                labels: trainedCategoryLabels,
                datasets: [{
                    label: 'Trained Category Distribution',
                    data: trainedCategoryData,
                    backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create trained memory usage chart
        new Chart(document.getElementById('trainedMemoryChart'), {
            type: 'bar',
            data: {
                labels: trainedCategoryLabels,
                datasets: [{
                    label: 'Memory Usage (MB)',
                    data: trainedMemoryData,
                    backgroundColor: '#36a2eb'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create trained battery usage chart
        new Chart(document.getElementById('trainedBatteryChart'), {
            type: 'bar',
            data: {
                labels: trainedCategoryLabels,
                datasets: [{
                    label: 'Battery Usage (%)',
                    data: trainedBatteryData,
                    backgroundColor: '#ffce56'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create trained network usage chart
        new Chart(document.getElementById('trainedNetworkChart'), {
            type: 'bar',
            data: {
                labels: trainedCategoryLabels,
                datasets: [{
                    label: 'Network Usage (KB/s)',
                    data: trainedNetworkData,
                    backgroundColor: '#cc65fe'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Function to render uploaded dataset charts (Uploaded charts)
    function renderUploadedDatasetCharts(result) {
        const categoryLabels = Object.keys(result.category_distribution);
        const categoryData = Object.values(result.category_distribution);
        const memoryData = Object.values(result.memory_usage);
        const batteryData = Object.values(result.battery_usage);
        const networkData = Object.values(result.network_usage);

        // Create uploaded dataset category distribution chart
        new Chart(document.getElementById('categoryChart'), {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Uploaded Category Distribution',
                    data: categoryData,
                    backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create uploaded dataset memory usage chart
        new Chart(document.getElementById('memoryChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Memory Usage (MB)',
                    data: memoryData,
                    backgroundColor: '#36a2eb'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create uploaded dataset battery usage chart
        new Chart(document.getElementById('batteryChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Battery Usage (%)',
                    data: batteryData,
                    backgroundColor: '#ffce56'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Create uploaded dataset network usage chart
        new Chart(document.getElementById('networkChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Network Usage (KB/s)',
                    data: networkData,
                    backgroundColor: '#cc65fe'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Function to render comparison charts between trained and uploaded datasets
    function renderComparisonCharts(result) {
        const categoryLabels = Object.keys(result.category_distribution);
        const uploadedCategoryData = Object.values(result.category_distribution);

        const comparisonCategoryData = {
            labels: categoryLabels,
            datasets: [
                {
                    label: 'Trained Dataset',
                    data: Object.values(trainedSummary.category_distribution),
                    backgroundColor: '#ff6384',
                },
                {
                    label: 'Uploaded Dataset',
                    data: uploadedCategoryData,
                    backgroundColor: '#36a2eb',
                },
            ],
        };

        // Comparison chart: Category
        new Chart(document.getElementById('categoryComparisonChart'), {
            type: 'bar',
            data: comparisonCategoryData,
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Comparison chart: Memory
        new Chart(document.getElementById('memoryComparisonChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [
                    {
                        label: 'Trained Memory Usage (MB)',
                        data: Object.values(trainedSummary.memory_usage),
                        backgroundColor: '#ff6384',
                    },
                    {
                        label: 'Uploaded Memory Usage (MB)',
                        data: Object.values(result.memory_usage),
                        backgroundColor: '#36a2eb',
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Comparison chart: Battery
        new Chart(document.getElementById('batteryComparisonChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [
                    {
                        label: 'Trained Battery Usage (%)',
                        data: Object.values(trainedSummary.battery_usage),
                        backgroundColor: '#ff6384',
                    },
                    {
                        label: 'Uploaded Battery Usage (%)',
                        data: Object.values(result.battery_usage),
                        backgroundColor: '#36a2eb',
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Comparison chart: Network
        new Chart(document.getElementById('networkComparisonChart'), {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [
                    {
                        label: 'Trained Network Usage (KB/s)',
                        data: Object.values(trainedSummary.network_usage),
                        backgroundColor: '#ff6384',
                    },
                    {
                        label: 'Uploaded Network Usage (KB/s)',
                        data: Object.values(result.network_usage),
                        backgroundColor: '#36a2eb',
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Function to open the chatbot page
    function openChatbot() {
        window.location.href = "/chatbot";
    }

    // Function to toggle between sections
    function showSection(section) {
        document.getElementById('dataPrediction').classList.add('hidden');
        document.getElementById('dataVisualization').classList.add('hidden');
        document.getElementById(section).classList.remove('hidden');
    }
</script>



</body>

</html>
